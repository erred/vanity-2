steps:
  - id: build-push
    name: 'gcr.io/kaniko-project/executor'
    args:
      - '--cache'
      - '--cache-ttl=168h'
      - '--context=.'
      - '--destination=${_REGISTRY}/${_APP}:${SHORT_SHA}'
      - '--destination=${_REGISTRY}/${_APP}:latest'
      - '--image-name-with-digest-file=.image.txt'
      - '--reproducible'
      - '--single-snapshot'
      - '--use-new-run'
      - '--ignore-var-run'

  - id: sign-latest
    name: 'gcr.io/projectsigstore/cosign'
    entrypoint: sh
    env:
      - 'TUF_ROOT=/tmp' # cosign tries to create $HOME/.sigstore
      - 'COSIGN_EXPERIMENTAL=1'
      - 'GOOGLE_SERVICE_ACCOUNT_NAME=cosign-signer@com-seankhliao.iam.gserviceaccount.com'
    args:
      - '-c'
      - 'cosign sign $(cat .image.txt)'

  - id: deploy
    name: 'gcr.io/google.com/cloudsdktool/google-cloud-cli:alpine'
    entrypoint: sh
    args:
      - '-c'
      - |
        gcloud run deploy ${_RUN} --image $(cat .image.txt) --region us-central1

substitutions:
  _APP: 'vanity'
  _REGISTRY: 'us-central1-docker.pkg.dev/com-seankhliao/run'
  _RUN: 'go-seankhliao-com'
images:
  - '${_REGISTRY}/${_APP}:${SHORT_SHA}'
  - '${_REGISTRY}/${_APP}:latest'
